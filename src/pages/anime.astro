---
import BaseLayout from "@layouts/BaseLayout.astro";
import Card from "@components/temple/Card.astro";
import { Icon } from "astro-icon/components";
import { TMDB_CONFIG } from "@config";
import * as fs from "node:fs";
import * as path from "node:path";

// 追番数据处理
const TMDB_IMG = "https://image.tmdb.org/t/p/w500";

const TMDB_API_KEY = TMDB_CONFIG?.apiKey || import.meta.env.TMDB_API_KEY;
const TMDB_LIST_ID = TMDB_CONFIG?.listId || "8556173";

// 1. 尝试读取本地数据作为默认值
let animeData: any[] = [];
try {
  const localPath = path.resolve("public/anime-list.json");
  if (fs.existsSync(localPath)) {
    const fileContent = fs.readFileSync(localPath, "utf-8");
    animeData = JSON.parse(fileContent);
  }
} catch (e) {
  console.warn("Local anime-list.json not found or invalid.");
}

// 2. 如果配置了 API Key，尝试从 TMDB 获取最新数据
if (TMDB_API_KEY) {
  try {
    console.log(`Fetching TMDB list: ${TMDB_LIST_ID}...`);
    
    // 第一次请求获取总页数
    const firstResponse = await fetch(`https://api.themoviedb.org/3/list/${TMDB_LIST_ID}?api_key=${TMDB_API_KEY}&language=zh-CN&page=1`);
    
    if (firstResponse.ok) {
      const firstData = await firstResponse.json();
      const totalPages = firstData.total_pages || 1;
      
      // 收集所有页面的数据
      let allItems = [...(firstData.items || [])];
      
      // 如果有多页，并发请求剩余页面
      if (totalPages > 1) {
        const promises = [];
        for (let page = 2; page <= totalPages; page++) {
          promises.push(
            fetch(`https://api.themoviedb.org/3/list/${TMDB_LIST_ID}?api_key=${TMDB_API_KEY}&language=zh-CN&page=${page}`)
              .then(res => res.json())
              .then(data => data.items || [])
          );
        }
        
        const remainingItems = await Promise.all(promises);
        remainingItems.forEach(items => allItems.push(...items));
      }
      
      // 构造符合本地结构的数据（数组包裹一个对象，对象包含 items）
      animeData = [{
        ...firstData,
        items: allItems
      }];
      
      console.log(`Successfully fetched ${allItems.length} items from TMDB (Total pages: ${totalPages}).`);
    } else {
      console.error(`Failed to fetch TMDB list: ${firstResponse.status} ${firstResponse.statusText}`);
    }
  } catch (error: any) {
    console.error("Error fetching TMDB list:", error.message);
    if (error.cause?.code === 'UND_ERR_CONNECT_TIMEOUT' || error.message.includes('fetch failed')) {
      console.warn("\n[提示] TMDB API 连接失败，这通常是因为网络问题（中国大陆无法直连）。");
      console.warn("如果你正在使用 VPN，请在终端设置代理环境变量，例如：");
      console.warn("PowerShell: $env:https_proxy=\"http://127.0.0.1:7890\"");
      console.warn("CMD: set https_proxy=http://127.0.0.1:7890");
      console.warn("（请将 7890 替换为你实际的代理端口）");
      console.warn("然后重新运行构建命令。\n");
    }
  }
}

// 确保 animeData 是数组（处理本地文件可能是单个对象的情况）
if (!Array.isArray(animeData)) {
  animeData = [animeData];
}

// 展平并标准化数据
const animeList = animeData.flatMap((group) => group.items || []).map(anime => {
  // 统一处理 TV 和 Movie 的字段差异
  // Movie: title, original_title, release_date
  // TV: name, original_name, first_air_date
  const title = anime.title || anime.name || "";
  const originalTitle = anime.original_title || anime.original_name || "";
  const date = anime.release_date || anime.first_air_date || "";
  const type = anime.media_type || 'tv';

  return {
    id: anime.id,
    title: title,
    originalTitle: originalTitle,
    poster: anime.poster_path ? TMDB_IMG + anime.poster_path : null,
    type: type,
    rating: anime.vote_average || 0,
    date: date,
    overview: anime.overview,
    link: `https://www.themoviedb.org/${type}/${anime.id}`
  };
});

// 统计数据
const totalCount = animeList.length;
const averageRating = (animeList.reduce((sum, a) => sum + (Number(a.rating) || 0), 0) / totalCount).toFixed(1);
---

<BaseLayout title="追番列表">
  <!-- 页面头部 -->
  <div class="mb-8 animate-fade-in-up">
    <h1 class="text-3xl md:text-4xl font-bold mb-4 flex items-center gap-3">
      <Icon name="lucide:tv" class="text-primary" />
      <span>追番列表</span>
    </h1>
    
    <!-- 统计卡片 -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
      <div class="stats shadow bg-base-100 border border-base-200">
        <div class="stat p-4">
          <div class="stat-figure text-primary">
            <Icon name="lucide:film" class="w-8 h-8" />
          </div>
          <div class="stat-title">总追番</div>
          <div class="stat-value text-primary">{totalCount}</div>
          <div class="stat-desc">部作品</div>
        </div>
      </div>
      
      <div class="stats shadow bg-base-100 border border-base-200">
        <div class="stat p-4">
          <div class="stat-figure text-secondary">
            <Icon name="lucide:star" class="w-8 h-8" />
          </div>
          <div class="stat-title">平均评分</div>
          <div class="stat-value text-secondary">{averageRating}</div>
          <div class="stat-desc">TMDB 评分</div>
        </div>
      </div>
    </div>

    <!-- 筛选工具栏 -->
    <div class="flex flex-col md:flex-row gap-4 bg-base-100 p-4 rounded-xl shadow-sm border border-base-200">
      <div class="flex-1 relative">
        <Icon name="lucide:search" class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-base-content/50" />
        <input 
          type="text" 
          id="search-input" 
          placeholder="搜索番剧..." 
          class="input input-bordered w-full pl-10 focus:input-primary"
        />
      </div>
      
      <div class="flex gap-2 overflow-x-auto pb-2 md:pb-0">
        <select id="type-filter" class="select select-bordered w-full md:w-auto focus:select-primary">
          <option value="all">全部类型</option>
          <option value="tv">TV 动画</option>
          <option value="movie">剧场版</option>
        </select>
        
        <select id="sort-filter" class="select select-bordered w-full md:w-auto focus:select-primary">
          <option value="rating-desc">评分最高</option>
          <option value="rating-asc">评分最低</option>
          <option value="date-desc">最新发布</option>
          <option value="date-asc">最早发布</option>
        </select>
      </div>
    </div>
  </div>

  <!-- 番剧列表 -->
  <div id="anime-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4 md:gap-6">
    {
      animeList.map((anime) => (
        <div 
          class="anime-card group relative h-full"
          data-title={anime.title.toLowerCase()}
          data-type={anime.type}
          data-rating={anime.rating}
          data-date={anime.date}
        >
          <Card class="h-full hover:shadow-xl transition-all duration-300 hover:-translate-y-1 overflow-hidden border border-base-200">
            <a href={anime.link} target="_blank" rel="noopener noreferrer" class="block h-full flex flex-col">
              <!-- 封面图容器 -->
              <div class="relative aspect-[2/3] overflow-hidden bg-base-200">
                {anime.poster ? (
                  <img
                    src={anime.poster}
                    alt={anime.title}
                    class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110"
                    loading="lazy"
                  />
                ) : (
                  <div class="w-full h-full flex items-center justify-center text-base-content/30">
                    <Icon name="lucide:image-off" class="w-12 h-12" />
                  </div>
                )}
                
                <!-- 评分角标 -->
                <div class="absolute top-2 right-2 bg-black/60 backdrop-blur-sm text-yellow-400 px-2 py-1 rounded-lg flex items-center gap-1 text-xs font-bold shadow-lg">
                  <Icon name="lucide:star" class="w-3 h-3 fill-current" />
                  <span>{anime.rating.toFixed(1)}</span>
                </div>

                <!-- 类型角标 -->
                <div class="absolute top-2 left-2 bg-primary/80 backdrop-blur-sm text-primary-content px-2 py-1 rounded-lg text-xs font-bold shadow-lg">
                  {anime.type === 'movie' ? '剧场版' : 'TV'}
                </div>

                <!-- 悬停遮罩 -->
                <div class="absolute inset-0 bg-black/80 opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex flex-col justify-center items-center p-4 text-center">
                  <p class="text-white text-sm line-clamp-6 mb-4 leading-relaxed">
                    {anime.overview || "暂无简介"}
                  </p>
                  <span class="btn btn-sm btn-primary btn-outline text-white border-white hover:bg-white hover:text-black hover:border-white gap-2">
                    <Icon name="lucide:external-link" class="w-4 h-4" />
                    查看详情
                  </span>
                </div>
              </div>

              <!-- 信息区域 -->
              <div class="p-3 flex-1 flex flex-col bg-base-100">
                <h2 class="font-bold text-base mb-1 line-clamp-1 group-hover:text-primary transition-colors" title={anime.title}>
                  {anime.title}
                </h2>
                <div class="flex items-center justify-between mt-auto text-xs text-base-content/60">
                  <span class="flex items-center gap-1">
                    <Icon name="lucide:calendar" class="w-3 h-3" />
                    {anime.date ? anime.date.split('-')[0] : '未知'}
                  </span>
                  <span class="flex items-center gap-1">
                    <Icon name="lucide:heart" class="w-3 h-3" />
                    TMDB
                  </span>
                </div>
              </div>
            </a>
          </Card>
        </div>
      ))
    }
  </div>

  <!-- 无结果提示 -->
  <div id="no-results" class="hidden flex-col items-center justify-center py-20 text-base-content/50">
    <Icon name="lucide:search-x" class="w-16 h-16 mb-4" />
    <p class="text-lg">没有找到匹配的番剧</p>
  </div>

  <script>
    // 客户端筛选逻辑
    document.addEventListener('astro:page-load', () => {
      const searchInput = document.getElementById('search-input') as HTMLInputElement;
      const typeFilter = document.getElementById('type-filter') as HTMLSelectElement;
      const sortFilter = document.getElementById('sort-filter') as HTMLSelectElement;
      const grid = document.getElementById('anime-grid');
      const noResults = document.getElementById('no-results');
      
      if (!grid || !searchInput || !typeFilter || !sortFilter) return;

      const cards = Array.from(grid.getElementsByClassName('anime-card')) as HTMLElement[];

      function filterAndSort() {
        const searchTerm = searchInput.value.toLowerCase();
        const typeValue = typeFilter.value;
        const sortValue = sortFilter.value;
        
        let visibleCount = 0;

        // 筛选
        const filteredCards = cards.filter(card => {
          const title = card.dataset.title || '';
          const type = card.dataset.type || '';
          
          const matchesSearch = title.includes(searchTerm);
          const matchesType = typeValue === 'all' || type === typeValue;
          
          const isVisible = matchesSearch && matchesType;
          card.style.display = isVisible ? '' : 'none';
          if (isVisible) visibleCount++;
          return isVisible;
        });

        // 排序
        filteredCards.sort((a, b) => {
          const ratingA = parseFloat(a.dataset.rating || '0');
          const ratingB = parseFloat(b.dataset.rating || '0');
          const dateA = a.dataset.date || '';
          const dateB = b.dataset.date || '';

          switch (sortValue) {
            case 'rating-desc': return ratingB - ratingA;
            case 'rating-asc': return ratingA - ratingB;
            case 'date-desc': return dateB.localeCompare(dateA);
            case 'date-asc': return dateA.localeCompare(dateB);
            default: return 0;
          }
        });

        // 重新排序 DOM
        filteredCards.forEach(card => grid?.appendChild(card));

        // 显示/隐藏无结果提示
        if (noResults) {
          noResults.style.display = visibleCount === 0 ? 'flex' : 'none';
        }
      }

      // 绑定事件
      searchInput.addEventListener('input', filterAndSort);
      typeFilter.addEventListener('change', filterAndSort);
      sortFilter.addEventListener('change', filterAndSort);
      
      // 初始排序
      filterAndSort();
    });
  </script>
</BaseLayout>
